<!-- noctura-uformer/backend/video_processor.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NocturaVision - Video File Processor</title>
    <style>
        html, body { height: 100vh; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #282c34; color: white; display: flex; flex-direction: column; }
        header { background-color: #20232a; padding: 15px 30px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .nav-bar { display: flex; gap: 15px; }
        .nav-button { padding: 8px 15px; border: 1px solid #61dafb; color: #61dafb; background-color: transparent; text-decoration: none; border-radius: 5px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s, color 0.2s; }
        .nav-button:hover { background-color: #4a4f5a; }
        .nav-button.active { background-color: #61dafb; color: #20232a; font-weight: bold; }
        .title-block { text-align: center; }
        .title-block h1 { margin: 0 0 5px 0; font-size: 2.2rem; }
        .title-block p { margin: 0; font-size: 1rem; color: #ccc; }
        .placeholder { width: 235px; }
        .page-content { display: flex; flex-grow: 1; padding: 20px; gap: 20px; box-sizing: border-box; min-height: 0; }
        .sidebar { flex: 0 0 350px; background-color: #3c4049; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 25px; overflow-y: auto; }
        .sidebar h2 { margin-top: 0; border-bottom: 1px solid #61dafb; padding-bottom: 10px; color: #61dafb; }
        .control-group { display: flex; flex-direction: column; gap: 10px; }
        .control-group label { font-weight: bold; font-size: 0.9rem; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0; }
        .actions-bar { display: flex; align-items: center; gap: 20px; background-color: #4a4f5a; padding: 15px; border-radius: 8px; flex-shrink: 0; }
        #startProcessingBtn, #stopProcessingBtn { font-size: 1.1rem; padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; background-color: #61dafb; color: #20232a; font-weight: bold; transition: background-color 0.2s; }
        #startProcessingBtn:hover:not(:disabled) { background-color: #52b8d8; }
        #startProcessingBtn:disabled, #stopProcessingBtn:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #status { font-style: italic; color: #ccc; }
        #status.error { color: #ff6b6b; font-weight: bold; }
        .video-feeds-container { display: flex; gap: 20px; flex-grow: 1; min-height: 0; }
        .video-box { flex: 1; background-color: #4a4f5a; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; min-width: 0; }
        .video-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .video-header h3 { margin: 0; color: #61dafb; }
        .video-header button, .video-header a { font-size: 0.9rem; padding: 8px 12px; border-radius: 5px; border: none; background-color: #61dafb; color: #20232a; font-weight: bold; cursor: pointer; text-decoration: none; }
        .video-player-wrapper { width: 100%; height: 100%; background-color: #20232a; border-radius: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .upload-area { border: 2px dashed #ccc; border-radius: 5px; padding: 20px; text-align: center; cursor: pointer; width: 80%; }
        .video { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 5px; border: 2px solid #ccc; background-color: #20232a; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <div class="nav-bar">
            <a href="wstest_uformer.html" class="nav-button">Live Stream</a>
            <a href="video_processor.html" class="nav-button active">Video File</a>
            <a href="image_processor.html" class="nav-button">Image File</a>
        </div>
        <div class="title-block">
            <h1>ðŸ¦‰ NocturaVision <span style="font-weight: 300; color: #ccc;">| Uformer</span></h1>
            <p>Video File Enhancement</p>
        </div>
        <div class="placeholder"></div>
    </header>
    <div class="page-content">
        <div class="sidebar">
            <h2>Video Controls</h2>
            <div class="control-group">
                <label>Enhancement Model</label>
                <p style="padding: 8px; background-color: #4a4f5a; border-radius: 4px; margin: 0;">Uformer (SIDD Pre-trained)</p>
            </div>
            <div class="control-group">
                <p style="font-size: 0.9rem; color: #ccc;">Note: Video file processing always uses the high-quality patch-based pipeline.</p>
            </div>
        </div>
        <div class="main-content">
            <div class="actions-bar">
                <button id="startProcessingBtn" disabled>Start Processing</button>
                <button id="stopProcessingBtn" disabled>Stop Processing</button>
                <p id="status">Please select a video file.</p>
            </div>
            <div class="video-feeds-container">
                <div class="video-box">
                    <div class="video-header">
                        <h3>Original Video</h3>
                        <input type="file" id="videoUpload" accept="video/mp4,video/mov,video/avi,video/mkv,video/webm" style="display: none;">
                        <button id="selectVideoBtn">Select Video</button>
                    </div>
                    <div id="original-player-wrapper" class="video-player-wrapper">
                        <div id="upload-area" class="upload-area">
                            <p>Drag & Drop a video file here or click this area</p>
                        </div>
                        <video id="originalVideo" controls class="video hidden"></video>
                    </div>
                </div>
                <div class="video-box">
                    <div class="video-header">
                        <h3>Enhanced Video</h3>
                        <a id="downloadBtn" href="#" class="hidden">Download</a>
                    </div>
                    <div id="processed-player-wrapper" class="video-player-wrapper">
                        <video id="processedVideo" controls class="video hidden"></video>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // DOM Elements and global variables
        const selectVideoBtn = document.getElementById('selectVideoBtn');
        const videoUploadInput = document.getElementById('videoUpload');
        const uploadArea = document.getElementById('upload-area');
        const originalVideo = document.getElementById('originalVideo');
        const processedVideo = document.getElementById('processedVideo');
        const startProcessingBtn = document.getElementById('startProcessingBtn');
        const stopProcessingBtn = document.getElementById('stopProcessingBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusSpan = document.getElementById('status');

        let selectedVideoFile = null;
        let pollingInterval = null; // To hold the interval ID for polling

        // --- Event Listeners ---
        selectVideoBtn.onclick = () => videoUploadInput.click();
        videoUploadInput.onchange = (event) => handleVideoFile(event.target.files[0]);

        uploadArea.ondragover = (event) => { event.preventDefault(); uploadArea.style.borderColor = '#61dafb'; };
        uploadArea.ondragleave = (event) => { event.preventDefault(); uploadArea.style.borderColor = '#ccc'; };
        uploadArea.ondrop = (event) => {
            event.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            if (event.dataTransfer.files && event.dataTransfer.files[0]) {
                handleVideoFile(event.dataTransfer.files[0]);
            }
        };
        uploadArea.onclick = () => videoUploadInput.click();

        startProcessingBtn.onclick = async () => {
            if (!selectedVideoFile) {
                statusSpan.textContent = "Error: No video selected.";
                statusSpan.classList.add('error');
                return;
            }

            statusSpan.textContent = `Uploading "${selectedVideoFile.name}"...`;
            statusSpan.classList.remove('error');
            startProcessingBtn.disabled = true;
            stopProcessingBtn.disabled = false;
            selectVideoBtn.disabled = true;
            videoUploadInput.disabled = true;
            downloadBtn.classList.add('hidden');
            processedVideo.classList.add('hidden');

            const formData = new FormData();
            formData.append("video_file", selectedVideoFile);

            try {
                const response = await fetch('http://127.0.0.1:8000/api/process_video', { 
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Server returned an unreadable error.' }));
                    throw new Error(errorData.detail || `Server responded with status ${response.status}`);
                }
                
                const result = await response.json();
                const taskId = result.task_id;
                statusSpan.textContent = `Processing started. Waiting for updates...`;
                
                pollStatus(taskId);

            } catch (error) {
                statusSpan.classList.add('error');
                statusSpan.textContent = `Error: ${error.message}. Is the backend running?`;
                resetUI();
            }
        };
        
        stopProcessingBtn.onclick = () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            statusSpan.textContent = "Processing stopped by user.";
            statusSpan.classList.remove('error');
            resetUI();
            console.log("Placeholder: A 'cancel' request should be sent to the backend.");
        };

        // --- Helper Functions ---
        function pollStatus(taskId) {
            if (pollingInterval) clearInterval(pollingInterval);

            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`http://127.0.0.1:8000/api/video_status/${taskId}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: `Server responded with status ${response.status}` }));
                        throw new Error(errorData.detail);
                    }
                    const data = await response.json();

                    statusSpan.textContent = `Status: ${data.status}...`;

                    if (data.status === 'completed') {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        statusSpan.textContent = "Processing complete! Video is ready.";
                        
                        // This will be the next step
                        const downloadUrl = `http://127.0.0.1:8000/api/download_video?filepath=${encodeURIComponent(data.result_path)}`;
                        downloadBtn.href = downloadUrl;
                        processedVideo.src = downloadUrl; // Set the video source to the download link

                        processedVideo.classList.remove('hidden');
                        downloadBtn.classList.remove('hidden');

                        resetUI();
                        stopProcessingBtn.disabled = true;

                    } else if (data.status === 'failed') {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        statusSpan.textContent = `Error: Processing failed. Reason: ${data.error}`;
                        statusSpan.classList.add('error');

                        resetUI();
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    statusSpan.textContent = `Error polling status: ${error.message}`;
                    statusSpan.classList.add('error');
                    resetUI();
                }
            }, 2000);
        }

        function resetUI() {
            startProcessingBtn.disabled = selectedVideoFile ? false : true;
            stopProcessingBtn.disabled = true;
            selectVideoBtn.disabled = false;
            videoUploadInput.disabled = false;
        }

        function handleVideoFile(file) {
            if (file && file.type.startsWith('video/')) {
                if (pollingInterval) clearInterval(pollingInterval); // Stop polling if a new file is selected
                selectedVideoFile = file;
                const videoURL = URL.createObjectURL(file);
                
                originalVideo.src = videoURL;
                originalVideo.classList.remove('hidden');
                uploadArea.classList.add('hidden');
                
                statusSpan.textContent = `Selected: "${file.name}". Ready to process.`;
                statusSpan.classList.remove('error');
                processedVideo.src = "";
                processedVideo.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                resetUI();
            } else {
                selectedVideoFile = null;
                statusSpan.textContent = "Please select a valid video file.";
                statusSpan.classList.add('error');
                originalVideo.classList.add('hidden');
                uploadArea.classList.remove('hidden');
                resetUI();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {});
    </script>
</body>
</html>
